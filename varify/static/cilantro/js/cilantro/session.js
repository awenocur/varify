define(["jquery","underscore","backbone","./models","./utils","./router","./core"],function(t,e,n,i,s,r,o){var a={SESSION_OPENING:"session:opening",SESSION_ERROR:"session:error",SESSION_UNAUTHORIZED:"session:unauthorized",SESSION_OPENED:"session:opened",SESSION_CLOSED:"session:closed"},u={concepts:i.Concepts,fields:i.FieldCollection,contexts:i.ContextCollection,views:i.ViewCollection,preview:i.Results,exporter:i.ExporterCollection,queries:i.QueryCollection,public_queries:i.QueryCollection},h=i.Model.extend({idAttribute:"url",options:function(){return o.config.get("session.defaults")},initialize:function(t,n){this.options=e.extend({},e.result(this,"options"),n),this.opened=!1,this.started=!1,this.opening=!1,this.state={},e.bindAll(this,"ping","startPing","stopPing")},validate:function(t){return t&&t.url?void 0:"url is required"},startPing:function(){this.links.ping&&this.options.ping&&!this._ping&&(this.ping(),this._ping=setInterval(this.ping,this.options.ping))},stopPing:function(){clearTimeout(this._ping),delete this._ping},ping:function(){var t=this;n.ajax({type:"GET",url:this.links.ping,dataType:"json",success:function(e){"timeout"===e.status&&(t.stopPing(),t.timeout(e.location))},error:function(e,n,i){t.stopPing(),"FOUND"===i&&this.timeout(e.getResponseHeader("Location"))}})},timeout:function(t){var e;e=t?'Your session timed out. Please <a href="'+t+'">refresh the page</a>.':"Your session timed out. Please refresh the page.",o.notify({header:"Session Timeout",message:e,dismissable:!1,timeout:!1,level:"warning"}),setTimeout(function(){t?window.location=location:window.location.reload()},5e3)},parse:function(t){t=t||{},this.title=t.title,this.version=t.version,this.data={};var n;e.each(t._links,function(t,e){(n=u[e])&&(this.data[e]=new n,this.data[e].url=t.href)},this),this.router=new r.Router({main:o.config.get("main"),root:o.config.get("root")});var i=this.get("routes");if(i)if("string"==typeof i){var s=this;require([i],function(t){s.router.register(t)})}else"function"==typeof i&&(i=i()),this.router.register(i);return t},open:function(){if(this.opened||this.opening)return this._opening.promise();if(!this.isValid())throw new Error(this.validationError);this.opening=!0,this._opening=t.Deferred();var e={url:this.get("url"),type:"GET",dataType:"json"},n=this.get("credentials");n&&t.extend(e,{type:"POST",contentType:"application/json",data:JSON.stringify(n)});var i=this;return this.fetch(e).always(function(){i.opening=!1}).done(function(t,e,n){i.opened=!0,i.response=t,i._opening.resolveWith(i,[i,t,e,n])}).fail(function(t,e,n){i.error=n,i._opening.rejectWith(i,[this,t,e,n])}),this._opening.promise()},close:function(){this.end(),this.opening=this.opened=!1,e.each(this.data,function(t){t.reset()}),delete this._opening,delete this.response,delete this.data},start:function(t,n){if(this.started)return!1;if(!this.opened)throw new Error("Session must be opened before loaded");this.started=!0,e.each(this.data,function(t){t.fetch({reset:!0})}),t&&this.router.register(t),this.router.start(n),this.startPing(),this.listenTo(o,{visible:this.startPing,hidden:this.stopPing}),o.isSupported(o.getSerranoVersion())||o.notify({header:"Serrano Version Unsupported",level:"warning",timeout:!1,message:"You are connecting to an unsupported version of Serrano. Some functionality may be broken or missing due to compatibility issues."})},end:function(){this.started=!1,this.stopPing(),this.stopListening(o,"visible hidden"),this.router.unregister()}}),l=n.Collection.extend({_switch:function(t){this.active!==t&&(delete this.pending,this.close(),this.active=t,this.trigger(a.SESSION_OPENED,t))},open:function(t,e){"object"==typeof t?e=t:(e=e||{},e.url=t);var n=this.get(e.url);n||(n=new h(e),this.add(n)),n!==this.active&&n!==this.pending&&(this.pending=n,this.trigger(a.SESSION_OPENING,n));var i=this;return n.open().done(function(){i.pending===n&&i._switch(n)}).fail(function(t,e,s,r){if(i.pending===n){i.pending=null;var o;o=401===e.statusCode||403===e.statusCode?a.SESSION_UNAUTHORIZED:a.SESSION_ERROR,i.trigger(o,n,r)}})},close:function(){if(this.active){var t=this.active;delete this.active,t.close(),this.trigger(a.SESSION_CLOSED,t)}},clear:function(){this.close(),this.reset()}});return e.extend({SessionManager:l,Session:h},a)});
//@ sourceMappingURL=session.js.map