define(["underscore","backbone","marionette","./phenotype/diagnoses","./phenotype/annotations","../../models","../../utils"],function(e,t,n,r,i,s,o){var u=n.Layout.extend({className:"modal hide",template:"varify/modals/phenotype",ui:{closeButton:"[data-target=close-phenotypes]",content:"[data-target=content]",personalInfo:"[data-target=personal-info]",error:"[data-target=error]",notes:"[data-target=notes]",pedigree:"[data-target=pedigree]",headerLabel:"[data-target=header-label]",loading:"[data-target=loading]",thumbnail:"[data-target=thumbnail]",recalculateButton:"[data-target=recalculate]",warning:"[data-target=warning]",hideOnRetrieve:"[data-action=hide-on-retrieve]"},regions:{confirmedDiagnoses:"[data-target=confirmed-diagnoses]",suspectedDiagnoses:"[data-target=suspected-diagnoses]",ruledOutDiagnoses:"[data-target=ruled-out-diagnoses]",annotations:"[data-target=annotations]"},events:{"click @ui.closeButton":"close","click @ui.recalculateButton":"recalculate"},alerts:{missingSample:"The phenotypes cannot be retrieved because there is not any sample selected. To select a sample, navigate to the Query page and open the Sample concept(under the Proband header). From this control, you can use the +/- buttons to add a sample to the list or enter a label directly in the text box. Once you have selected a sample, click the &quot;Apply Filter&quot; button and then return to this page and reopen this window to retrieve the phenotypes.",multipleSamples:"The phenotypes cannot be retrieved because there are multiple samples selected. To fix this, navigate to the Query page and open the Sample concept(under the Proband header). From this control you can remove samples directly from the text box or using the - buttons. Once you have limited the set to a singe sample, click the &quot;Update Filterbutton and then return to this page and reopen this window to retrieve the phenotypes"},initialize:function(){this.data={},e.bindAll(this,"onFetchError");if(!(this.data.context=this.options.context))throw new Error("context model required")},renderNotes:function(e){var t=[];return t.push("<div class=span6>"),t.push("<h6>Notes:</h6>"),e&&e.length?t.push("<p>"+e[0].note):t.push("<span class=muted>No notes</span>"),t.join("")},onFetchError:function(){delete this.request,this.ui.loading.hide(),this.ui.error.html("There was an error retrieving the phenotypes.").show()},recalculate:function(){this.retrievePhenotypes(!0)},onRender:function(){delete this.request,this.ui.recalculateButton.prop("disabled",!1),this.ui.loading.hide();if(!this.model)return;this.annotations.show(new i.Annotations({name:"HPO Annotations",collection:new t.Collection(this.model.get("hpoAnnotations"))})),this.confirmedDiagnoses.show(new r.Diagnoses({name:"Confirmed Diagnoses",collection:new t.Collection(this.model.get("confirmedDiagnoses"))})),this.suspectedDiagnoses.show(new r.Diagnoses({name:"Suspected Diagnoses",collection:new t.Collection(this.model.get("suspectedDiagnoses"))})),this.ruledOutDiagnoses.show(new r.Diagnoses({name:"Ruled Out Diagnoses",collection:new t.Collection(this.model.get("ruledOutDiagnoses"))})),this.ui.notes.html(this.renderNotes(this.model.get("notes"))),this.model.get("pedigree")||(this.ui.pedigree.hide(),this.ui.thumbnail.hide()),this.ui.content.show()},retrievePhenotypes:function(e){e===null&&(e=!1),this.ui.hideOnRetrieve.hide(),this.ui.recalculateButton.prop("disabled",!0);var t=o.samplesInContext(this.data.context);if(t.length===1){this.ui.headerLabel.text("Phenotypes for "+t[0]),this.ui.loading.show();var n=new s.Phenotype({sampleId:t[0]}),r=this;this.request=n.fetch({data:{recalculate_rankings:e},processData:!0,success:function(e){r.model=e,r.render(),r.ui.headerLabel.text("Phenotypes for "+t[0])},error:this.onFetchError})}else this.ui.headerLabel.text("Phenotypes"),t.length===0?this.ui.error.html(this.alerts.missingSample):this.ui.error.html(this.alerts.multipleSamples).show()},open:function(){this.retrievePhenotypes(),this.$el.modal("show")},close:function(){this.request&&(this.request.abort(),delete this.request),this.$el.modal("hide")}});return{Phenotype:u}})