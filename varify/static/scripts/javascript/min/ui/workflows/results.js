var __bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define(["underscore","marionette","cilantro","cilantro/ui/numbers","../tables","../modals","../../models","../../utils"],function(e,t,n,r,i,s,o,u){var a,f;return a=function(t){function n(){return this.onRender=__bind(this.onRender,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.tagName="span",n.prototype.className="result-count",n.prototype.template="count",n.prototype.ui={count:".count",label:".count-label"},n.prototype.modelEvents={"change:objectcount":"renderCount"},n.prototype.initialize=function(){this.data={};if(!(this.data.context=this.options.context))throw new Error("context model required")},n.prototype.onRender=function(){return this.renderCount(this.model,this.model.objectCount!=null||""?this.model.objectCount:void 0)},n.prototype.renderCount=function(t,n,i){var s,o;return o=null,this.data.context!=null&&(s=this.data.context.get("json"))!=null&&e.each(s.children,function(e){if(e.concept!=null&&e.concept===2)return o=e.children[0].value[0].label}),r.renderCount(this.ui.count,n),this.ui.label.text("records in "+(o||"various samples")),this.ui.label.attr("title",o),o!=null?this.ui.label.tooltip({animation:!1,html:!0,placement:"bottom",container:"body"}):this.ui.label.tooltip("destroy")},n}(t.ItemView),f=function(t){function r(){return this.retrievePhenotypes=__bind(this.retrievePhenotypes,this),this.recalculateRankingsClicked=__bind(this.recalculateRankingsClicked,this),this.viewPhenotypesClicked=__bind(this.viewPhenotypesClicked,this),this.sampleID=__bind(this.sampleID,this),this.phenotypesError=__bind(this.phenotypesError,this),this.hidePhenotypes=__bind(this.hidePhenotypes,this),this.renderPhenotypes=__bind(this.renderPhenotypes,this),this.showSaveQuery=__bind(this.showSaveQuery,this),this.exportData=__bind(this.exportData,this),this.startExport=__bind(this.startExport,this),this.checkExportStatus=__bind(this.checkExportStatus,this),this.onExportFinished=__bind(this.onExportFinished,this),this.onPageScroll=__bind(this.onPageScroll,this),this.hideContextPanel=__bind(this.hideContextPanel,this),this.showContextPanel=__bind(this.showContextPanel,this),this.toggleContextPanelButtonClicked=__bind(this.toggleContextPanelButtonClicked,this),this.updateContextPanelOffsets=__bind(this.updateContextPanelOffsets,this),this.onWindowResize=__bind(this.onWindowResize,this),this.hideLoadingOverlay=__bind(this.hideLoadingOverlay,this),this.showLoadingOverlay=__bind(this.showLoadingOverlay,this),this.onExportClicked=__bind(this.onExportClicked,this),this.onExportCloseClicked=__bind(this.onExportCloseClicked,this),this.onRouterLoad=__bind(this.onRouterLoad,this),this.onRouterUnload=__bind(this.onRouterUnload,this),r.__super__.constructor.apply(this,arguments)}return __extends(r,t),r.prototype.className="results-workflow",r.prototype.template="varify/workflows/results",r.prototype.requestDelay=2500,r.prototype.requestTimeout=6e4,r.prototype.monitorDelay=500,r.prototype.monitorTimeout=6e5,r.prototype.numPendingDownloads=0,r.prototype.pageRangePattern=/^[0-9]+(\.\.\.[0-9]+)?$/,r.prototype.ui={contextContainer:".context-container",saveQuery:".save-query-modal",saveQueryToggle:"[data-toggle=save-query]",exportOptions:".export-options-modal",exportProgress:".export-progress-modal",toggleFiltersButton:"[data-toggle=context-panel]",toggleFiltersIcon:"[data-toggle=context-panel] i",toggleFiltersText:"[data-toggle=context-panel] span",navbar:".results-workflow-navbar",resultsContainer:".results-container",navbarButtons:".results-workflow-navbar button",loadingOverlay:".loading-overlay",viewPhenotype:".phenotype-modal .modal-body .span12",recalculateButton:"[data-target=recalculate-rankings]",phenotypeWarning:"[data-target=phenotype-warning]"},r.prototype.events={"click .export-options-modal [data-save]":"onExportClicked","click .export-options-modal [data-dismiss=modal]":"onExportCloseClicked","click [data-toggle=export-options]":"showExportOptions","click [data-toggle=export-progress]":"showExportProgress","click #pages-text-ranges":"selectPagesOption","click [data-toggle=save-query]":"showSaveQuery","click [data-toggle=context-panel]":"toggleContextPanelButtonClicked","show.bs.modal .phenotype-modal":"viewPhenotypesClicked","hidden.bs.modal .phenotype-modal":"hidePhenotypes","click [data-target=recalculate-rankings]":"recalculateRankingsClicked"},r.prototype.regions={columns:"#export-columns-tab",count:".count-region",table:".table-region",paginator:".paginator-region",context:".context-region",exportTypes:".export-type-region",exportProgress:".export-progress-region",saveQueryModal:".save-query-modal",resultDetailsModal:".result-details-modal"},r.prototype.initialize=function(){this.data={};if(!(this.data.context=this.options.context))throw new Error("context model required");if(!(this.data.view=this.options.view))throw new Error("view model required");if(!(this.data.concepts=this.options.concepts))throw new Error("concepts collection required");if(!(this.data.results=this.options.results))throw new Error("results collection required");if(!(this.data.exporters=this.options.exporters))throw new Error("exporters collection required");if(!(this.data.queries=this.options.queries))throw new Error("queries collection required");return $(document).on("scroll",this.onPageScroll),$(window).resize(this.onWindowResize),this.data.results.on("request",this.showLoadingOverlay),this.data.results.on("sync",this.hideLoadingOverlay),this.monitors={},this.areFiltersManuallyHidden=!1,this.areFiltersHidden=!1,this.on("router:load",this.onRouterLoad),this.on("router:unload",this.onRouterUnload),n.on("resultRow:click",function(e){return function(t,n){return e.resultDetailsModal.currentView.update(t,n)}}(this))},r.prototype.onRouterUnload=function(){return this.data.results.trigger("workspace:unload")},r.prototype.onRouterLoad=function(){return this.data.results.trigger("workspace:load"),this.showContextPanel()},r.prototype.onExportCloseClicked=function(){return e.delay(function(e){return function(){return e.columns.currentView.resetFacets()}}(this),25)},r.prototype.onExportClicked=function(){return this.columns.currentView.data.facets.length===0?(this.$("#export-error-message").html("One or more columns must be selected. Click the &quot;Columns&quot; tab, add at least one column using the green &quot;plus&quot; buttons next to the column names, and click &quot;Export&quot; to try again."),this.$(".export-options-modal .alert-block").show()):e.isEqual(e.pluck(this.data.view.facets.models,"id"),e.pluck(this.columns.currentView.data.facets.models,"id"))?this.exportData():(this.data.view.facets.reset(this.columns.currentView.data.facets.toJSON()),this.data.view.save({},{success:this.exportData}))},r.prototype.showLoadingOverlay=function(){if(this.isClosed!=null&&!this.isClosed)return this.ui.loadingOverlay.show()},r.prototype.hideLoadingOverlay=function(){if(this.isClosed!=null&&!this.isClosed)return this.ui.loadingOverlay.hide()},r.prototype.onWindowResize=function(){return this.updateContextPanelOffsets()},r.prototype.updateContextPanelOffsets=function(){if(this.isClosed==null||this.isClosed)return;return this.workflowTopOffset=this.$el.offset().top,this.workflowRightOffset=window.innerWidth-(this.$el.offset().left+this.$el.width()),this.ui.contextContainer.css("top",this.workflowTopOffset),this.ui.contextContainer.css("right",this.workflowRightOffset)},r.prototype.toggleContextPanelButtonClicked=function(){return this.areFiltersHidden?(this.areFiltersManuallyHidden=!1,this.showContextPanel()):(this.areFiltersManuallyHidden=!0,this.hideContextPanel())},r.prototype.showContextPanel=function(){return this.areFiltersHidden=!1,this.ui.contextContainer.css("display","block"),this.ui.resultsContainer.addClass("span9"),this.ui.toggleFiltersButton.tooltip("hide").attr("data-original-title","Hide Filter Panel").tooltip("fixTitle"),this.ui.toggleFiltersIcon.removeClass("icon-collapse-alt"),this.ui.toggleFiltersIcon.addClass("icon-expand-alt"),this.ui.toggleFiltersText.html("Hide Filters"),this.updateContextPanelOffsets(),this.$(".context").stacked("restack",this.$el.height())},r.prototype.hideContextPanel=function(){return this.areFiltersHidden=!0,this.ui.contextContainer.css("display","none"),this.ui.resultsContainer.removeClass("span9"),this.ui.toggleFiltersButton.tooltip("hide").attr("data-original-title","Show Filter Panel").tooltip("fixTitle"),this.ui.toggleFiltersIcon.addClass("icon-collapse-alt"),this.ui.toggleFiltersIcon.removeClass("icon-expand-alt"),this.ui.toggleFiltersText.html("Show Filters")},r.prototype.onPageScroll=function(){var e;if(this.isClosed==null||this.isClosed)return;e=$(document).scrollTop();if(this.ui.navbar.hasClass("navbar-fixed-top")){if(e<this.navbarVerticalOffset-this.topNavbarHeight){this.ui.navbar.removeClass("navbar-fixed-top"),this.ui.contextContainer.css("top",this.workflowTopOffset);if(!this.areFiltersManuallyHidden)return this.showContextPanel()}}else if(e>=this.navbarVerticalOffset-this.topNavbarHeight){this.ui.navbar.css("top",this.topNavbarHeight),this.ui.navbar.addClass("navbar-fixed-top"),this.ui.contextContainer.css("top",this.workflowTopOffset+35);if(!this.areFiltersManuallyHidden)return this.hideContextPanel()}},r.prototype.selectPagesOption=function(){return this.$("#pages-radio-all").prop("checked",!1),this.$("#pages-radio-ranges").prop("checked",!0),this.$("#pages-text-ranges").val("")},r.prototype.changeExportStatus=function(e,t){var n;n=this.$(".export-status-"+e+" .span10"),n.children().hide();switch(t){case"pending":return n.find(".pending-container").show();case"downloading":return n.find(".progress").show();case"error":return n.find(".label-important").show();case"success":return n.find(".label-success").show();case"timeout":return n.find(".label-timeout").show()}},r.prototype.onExportFinished=function(e){this.numPendingDownloads=this.numPendingDownloads-1,this.$(".export-progress-container .badge-info").html(this.numPendingDownloads),this.hasExportErrorOccurred(e)?this.changeExportStatus(e,"error"):this.monitors[e].execution_time>this.monitorTimeout?this.changeExportStatus(e,"timeout"):this.changeExportStatus(e,"success");if(this.numPendingDownloads===0)return this.$("[data-toggle=export-options]").prop("disabled",!1),this.$(".export-progress-container").hide()},r.prototype.hasExportErrorOccurred=function(e){return this.$("#export-download-"+e).contents()[0].body.children.length!==0},r.prototype.checkExportStatus=function(e){var t;this.monitors[e].execution_time=this.monitors[e].execution_time+this.monitorDelay,t="export-type-"+e.toLowerCase();if(n.utils.getCookie(t)==="complete")return clearInterval(this.monitors[e].interval),n.utils.setCookie(t,null),this.onExportFinished(e);if(this.monitors[e].execution_time>this.monitorTimeout||this.hasExportErrorOccurred(e))return clearInterval(this.monitors[e].interval),this.onExportFinished(e)},r.prototype.startExport=function(e,t){var r,i,s,o;return s=this.$(e).attr("title"),this.changeExportStatus(s,"downloading"),r="export-type-"+s.toLowerCase(),n.utils.setCookie(r,null),o=this.$(e).attr("href"),o[o.length-1]!=="/"&&(o=""+o+"/"),o=""+o+t,i="<iframe id=export-download-"+s+" src="+o+" style='display: none'></iframe>",this.$(".export-iframe-container").append(i),this.monitors[s]={execution_time:0,interval:setInterval(this.checkExportStatus,this.monitorDelay,s)}},r.prototype.initializeExportStatusIndicators=function(e){var t,n,r,i;this.$(".export-status-container").children().hide(),i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(this.$(".export-status-"+t.title).show());return i},r.prototype.isPageRangeValid=function(){var e;return this.$("input[name=pages-radio]:checked").val()==="all"?!0:(e=this.$("#pages-text-ranges").val(),this.pageRangePattern.test(e))},r.prototype.exportData=function(e){var t,n,r,i,s,o,u;this.$(".export-iframe-container").empty(),i=this.$("input[name=export-type-checkbox]:checked");if(i.length===0)return this.$("#export-error-message").html("An export type must be selected."),this.$(".export-options-modal .alert-block").show();if(!this.isPageRangeValid())return this.$("#export-error-message").html("Please enter a valid page range. The page range must be a single page(example: 1) or a range of pages(example: 2...5)."),this.$(".export-options-modal .alert-block").show();this.$(".export-options-modal .alert-block").hide(),this.numPendingDownloads=i.length,r="",this.$("input[name=pages-radio]:checked").val()!=="all"&&(r=this.$("#pages-text-ranges").val()+"/"),this.$("[data-toggle=export-options]").prop("disabled",!0),this.$(".export-progress-container").show(),this.$(".export-progress-container .badge-info").html(this.numPendingDownloads),this.ui.exportOptions.modal("hide"),this.initializeExportStatusIndicators(i),this.ui.exportProgress.modal("show"),t=this.requestDelay,u=[];for(n=s=0,o=i.length-1;s<=o;n=s+=1)this.changeExportStatus(this.$(i[n]).attr("title"),"pending"),u.push(setTimeout(this.startExport,n*t,i[n],r));return u},r.prototype.onRender=function(){var e;n.isSupported("2.1.0")||(this.ui.saveQueryToggle.remove(),this.ui.saveQuery.remove()),this.paginator.show(new n.ui.Paginator({model:this.data.results})),this.count.show(new a({model:this.data.results,context:this.data.context})),this.exportTypes.show(new n.ui.ExportTypeCollection({collection:this.data.exporters})),this.exportProgress.show(new n.ui.ExportProgressCollection({collection:this.data.exporters})),this.resultDetailsModal.show(new s.ResultDetails),this.saveQueryModal.show(new n.ui.EditQueryDialog({header:"Save Query",view:this.data.view,context:this.data.context,collection:this.data.queries})),this.context.show(new n.ui.ContextPanel({model:this.data.context})),this.context.currentView.$el.stacked({fluid:".tree-region"}),this.table.show(new i.ResultTable({collection:this.data.results,view:this.data.view})),this.table.currentView.on("render",function(e){return function(){return e.$(".context").stacked("restack",e.$el.height())}}(this)),this.columns.show(new n.ui.ConceptColumns({view:this.data.view,concepts:this.data.concepts})),this.ui.navbarButtons.tooltip({animation:!1,placement:"bottom"}),this.navbarVerticalOffset==null&&(this.navbarVerticalOffset=this.ui.navbar.offset().top),this.topNavbarHeight==null&&(e=$(".navbar-fixed-top"),e.length?this.topNavbarHeight=e.height():this.topNavbarHeight=0);if(this.workflowTopOffset==null)return this.updateContextPanelOffsets()},r.prototype.showExportOptions=function(){this.$(".export-options-modal .alert-block").hide(),this.ui.exportOptions.modal("show");if(this.data.exporters.length===0)return this.$(".export-options-modal .btn-primary").prop("disabled",!0)},r.prototype.showExportProgress=function(){return this.ui.exportProgress.modal("show")},r.prototype.showSaveQuery=function(){return this.saveQueryModal.currentView.open()},r.prototype.renderPhenotypes=function(t,r,i){var s,o,a;if(!this.ui.viewPhenotype.is(":visible"))return;this.ui.viewPhenotype.find(".loading").hide(),this.ui.recalculateButton.prop("disabled",!1),s=t.attributes,s.hpoAnnotations&&s.hpoAnnotations.length&&(s.hpoAnnotations=e.sortBy(s.hpoAnnotations,function(e){return parseInt(e.priority)||t.lowestPriority+1})),s.confirmedDiagnoses&&s.confirmedDiagnoses.length&&(s.confirmedDiagnoses=e.sortBy(s.confirmedDiagnoses,function(e){return parseInt(e.priority)||t.lowestPriority+1})),s.suspectedDiagnoses&&s.suspectedDiagnoses.length&&(s.suspectedDiagnoses=e.sortBy(s.suspectedDiagnoses,function(e){return parseInt(e.priority)||t.lowestPriority+1})),s.ruledOutDiagnoses&&s.ruledOutDiagnoses.length&&(s.ruledOutDiagnoses=e.sortBy(s.ruledOutDiagnoses,function(e){return parseInt(e.priority)||t.lowestPriority+1})),o=u.parseISO8601UTC(s.last_modified),o!=null?s.last_modified=o.toLocaleString():s.last_modified="N/A",a=u.parseISO8601UTC(s.phenotype_modified),a!=null?(s.phenotype_modified=a.toLocaleString(),o!=null&&o>a&&(this.ui.phenotypeWarning.text("The phenotypes for this sample have been updated recently and the gene rankings may be out of date. You can update these ranking based on the latest phenotypes by clicking on the 'Recalculate Rankings' button below."),this.ui.phenotypeWarning.show())):(s.phenotype_modified="N/A",o!=null&&(this.ui.phenotypeWarning.show(),this.ui.phenotypeWarning.text("This sample has phenotype data but has not yet had gene rankings calculated based on the associated phenotype. You can update these rankings now by clicking on the 'Recalculate Rankings' button below."))),this.ui.viewPhenotype.find(".content").html(n.templates.get("varify/modals/phenotype")(t.attributes)),this.phenotypeXhr=void 0;if(i===!0)return n.trigger(n.VIEW_SYNCED)},r.prototype.hidePhenotypes=function(){return this.phenotypeXhr&&this.phenotypeXhr.abort(),this.phenotypeXhr=void 0,this.ui.viewPhenotype.find(".content").empty(),this.ui.viewPhenotype.find(".loading").show()},r.prototype.phenotypesError=function(e,t){var n;if(t.statusText==="abort")return;return this.ui.viewPhenotype.find(".loading").hide(),(e!=null?(n=e.attributes)!=null?n.sample_id:void 0:void 0)!=null?this.ui.viewPhenotype.find(".content").html("<p>An error was encountered. "+("Unable to retrieve phenotypes for sample '"+e.attributes.sample_id+"'.</p>")):this.ui.viewPhenotype.find(".content").html("<p>An error was encountered. No sample is selected.</p>"),this.phenotypeXhr=void 0},r.prototype.sampleID=function(){var t,n;return n="various samples",this.data.context!=null&&(t=this.data.context.get("json"))!=null&&e.each(t.children,function(e){if(e.concept!=null&&e.concept===2)return n=e.children[0].value[0].label}),n},r.prototype.viewPhenotypesClicked=function(){return this.retrievePhenotypes()},r.prototype.recalculateRankingsClicked=function(){return this.phenotypeXhr&&this.phenotypeXhr.abort(),this.phenotypeXhr=void 0,this.ui.viewPhenotype.find(".content").empty(),this.ui.viewPhenotype.find(".loading").show(),this.retrievePhenotypes(!0)},r.prototype.retrievePhenotypes=function(e){var t,n;return e==null&&(e=!1),this.ui.recalculateButton.prop("disabled",!0),this.ui.phenotypeWarning.hide(),n=this.sampleID(),n?($(".phenotype-sample-label").html("("+n+")"),t=new o.Phenotype({sample_id:n}),this.phenotypeXhr=t.fetch({data:{recalculate_rankings:e},processData:!0,success:function(t){return function(n,r){return t.renderPhenotypes(n,r,e)}}(this),error:this.phenotypesError})):($(".phenotype-sample-label").html(""),this.phenotypesError(t,{}))},r}(t.Layout),{ResultsWorkflow:f}})