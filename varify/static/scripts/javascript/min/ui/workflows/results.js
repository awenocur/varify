var __slice=[].slice,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};define(["underscore","marionette","cilantro","cilantro/ui/numbers","../tables","../modals","../../models","tpl!templates/count.html","tpl!templates/varify/workflows/results.html","tpl!templates/varify/modals/phenotypes.html"],function(){var e,t,n,r,i,s,o,u,a,f;return f=arguments[0],e=arguments[1],r=arguments[2],o=arguments[3],u=arguments[4],i=arguments[5],s=arguments[6],a=8<=arguments.length?__slice.call(arguments,7):[],a=f.object(["count","results","phenotypes"],a),t=function(e){function t(){return this.onRender=__bind(this.onRender,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.tagName="span",t.prototype.className="result-count",t.prototype.template=a.count,t.prototype.ui={count:".count",label:".count-label"},t.prototype.modelEvents={"change:objectcount":"renderCount"},t.prototype.initialize=function(){this.data={};if(!(this.data.context=this.options.context))throw new Error("context model required")},t.prototype.onRender=function(){return this.renderCount(this.model,this.model.objectCount!=null||""?this.model.objectCount:void 0)},t.prototype.renderCount=function(e,t,n){var r,i;return i=null,this.data.context!=null&&(r=this.data.context.get("json"))!=null&&f.each(r.children,function(e){if(e.concept!=null&&e.concept===2)return i=e.children[0].value[0].label}),o.renderCount(this.ui.count,t),this.ui.label.text("records in "+(i||"various samples")),this.ui.label.attr("title",i),i!=null?this.ui.label.tooltip({animation:!1,html:!0,placement:"bottom",container:"body"}):this.ui.label.tooltip("destroy")},t}(e.ItemView),n=function(e){function n(){return this.retrievePhenotypes=__bind(this.retrievePhenotypes,this),this.sampleID=__bind(this.sampleID,this),this.phenotypesError=__bind(this.phenotypesError,this),this.hidePhenotypes=__bind(this.hidePhenotypes,this),this.renderPhenotypes=__bind(this.renderPhenotypes,this),this.showSaveQuery=__bind(this.showSaveQuery,this),this.exportData=__bind(this.exportData,this),this.startExport=__bind(this.startExport,this),this.checkExportStatus=__bind(this.checkExportStatus,this),this.onExportFinished=__bind(this.onExportFinished,this),this.onPageScroll=__bind(this.onPageScroll,this),this.hideContextPanel=__bind(this.hideContextPanel,this),this.showContextPanel=__bind(this.showContextPanel,this),this.toggleContextPanelButtonClicked=__bind(this.toggleContextPanelButtonClicked,this),this.updateContextPanelOffsets=__bind(this.updateContextPanelOffsets,this),this.onWindowResize=__bind(this.onWindowResize,this),this.hideLoadingOverlay=__bind(this.hideLoadingOverlay,this),this.showLoadingOverlay=__bind(this.showLoadingOverlay,this),this.onExportClicked=__bind(this.onExportClicked,this),this.onExportCloseClicked=__bind(this.onExportCloseClicked,this),this.onRouterLoad=__bind(this.onRouterLoad,this),this.onRouterUnload=__bind(this.onRouterUnload,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.className="results-workflow",n.prototype.template=a.results,n.prototype.requestDelay=2500,n.prototype.requestTimeout=6e4,n.prototype.monitorDelay=500,n.prototype.monitorTimeout=6e5,n.prototype.numPendingDownloads=0,n.prototype.pageRangePattern=/^[0-9]+(\.\.\.[0-9]+)?$/,n.prototype.ui={contextContainer:".context-container",saveQuery:".save-query-modal",saveQueryToggle:"[data-toggle=save-query]",exportOptions:".export-options-modal",exportProgress:".export-progress-modal",toggleFiltersButton:"[data-toggle=context-panel]",toggleFiltersIcon:"[data-toggle=context-panel] i",toggleFiltersText:"[data-toggle=context-panel] span",navbar:".results-workflow-navbar",resultsContainer:".results-container",navbarButtons:".results-workflow-navbar button",loadingOverlay:".loading-overlay",viewPhenotype:".phenotype-modal .modal-body .span12",recalculateButton:"[data-target=recalculate-rankings]"},n.prototype.events={"click .export-options-modal [data-save]":"onExportClicked","click .export-options-modal [data-dismiss=modal]":"onExportCloseClicked","click [data-toggle=export-options]":"showExportOptions","click [data-toggle=export-progress]":"showExportProgress","click #pages-text-ranges":"selectPagesOption","click [data-toggle=save-query]":"showSaveQuery","click [data-toggle=context-panel]":"toggleContextPanelButtonClicked","show.bs.modal .phenotype-modal":"retrievePhenotypes","hidden.bs.modal .phenotype-modal":"hidePhenotypes"},n.prototype.regions={columns:"#export-columns-tab",count:".count-region",table:".table-region",paginator:".paginator-region",context:".context-region",exportTypes:".export-type-region",exportProgress:".export-progress-region",saveQueryModal:".save-query-modal",resultDetailsModal:".result-details-modal"},n.prototype.initialize=function(){this.data={};if(!(this.data.context=this.options.context))throw new Error("context model required");if(!(this.data.view=this.options.view))throw new Error("view model required");if(!(this.data.concepts=this.options.concepts))throw new Error("concepts collection required");if(!(this.data.results=this.options.results))throw new Error("results collection required");if(!(this.data.exporters=this.options.exporters))throw new Error("exporters collection required");if(!(this.data.queries=this.options.queries))throw new Error("queries collection required");return $(document).on("scroll",this.onPageScroll),$(window).resize(this.onWindowResize),this.data.results.on("request",this.showLoadingOverlay),this.data.results.on("sync",this.hideLoadingOverlay),this.monitors={},this.areFiltersManuallyHidden=!1,this.areFiltersHidden=!1,this.on("router:load",this.onRouterLoad),this.on("router:unload",this.onRouterUnload),r.on("resultRow:click",function(e){return function(t,n){return e.resultDetailsModal.currentView.update(t,n)}}(this))},n.prototype.onRouterUnload=function(){return this.data.results.trigger("workspace:unload")},n.prototype.onRouterLoad=function(){return this.data.results.trigger("workspace:load"),this.showContextPanel()},n.prototype.onExportCloseClicked=function(){return f.delay(function(e){return function(){return e.columns.currentView.resetFacets()}}(this),25)},n.prototype.onExportClicked=function(){return f.isEqual(f.pluck(this.data.view.facets.models,"id"),f.pluck(this.columns.currentView.data.facets.models,"id"))?this.exportData():(this.data.view.facets.reset(this.columns.currentView.data.facets.toJSON()),this.data.view.save({},{success:this.exportData}))},n.prototype.showLoadingOverlay=function(){if(this.isClosed!=null&&!this.isClosed)return this.ui.loadingOverlay.show()},n.prototype.hideLoadingOverlay=function(){if(this.isClosed!=null&&!this.isClosed)return this.ui.loadingOverlay.hide()},n.prototype.onWindowResize=function(){return this.updateContextPanelOffsets()},n.prototype.updateContextPanelOffsets=function(){if(this.isClosed==null||this.isClosed)return;return this.workflowTopOffset=this.$el.offset().top,this.workflowRightOffset=window.innerWidth-(this.$el.offset().left+this.$el.width()),this.ui.contextContainer.css("top",this.workflowTopOffset),this.ui.contextContainer.css("right",this.workflowRightOffset)},n.prototype.toggleContextPanelButtonClicked=function(){return this.areFiltersHidden?(this.areFiltersManuallyHidden=!1,this.showContextPanel()):(this.areFiltersManuallyHidden=!0,this.hideContextPanel())},n.prototype.showContextPanel=function(){return this.areFiltersHidden=!1,this.ui.contextContainer.css("display","block"),this.ui.resultsContainer.addClass("span9"),this.ui.toggleFiltersButton.tooltip("hide").attr("data-original-title","Hide Filter Panel").tooltip("fixTitle"),this.ui.toggleFiltersIcon.removeClass("icon-collapse-alt"),this.ui.toggleFiltersIcon.addClass("icon-expand-alt"),this.ui.toggleFiltersText.html("Hide Filters"),this.updateContextPanelOffsets(),this.$(".context").stacked("restack",this.$el.height())},n.prototype.hideContextPanel=function(){return this.areFiltersHidden=!0,this.ui.contextContainer.css("display","none"),this.ui.resultsContainer.removeClass("span9"),this.ui.toggleFiltersButton.tooltip("hide").attr("data-original-title","Show Filter Panel").tooltip("fixTitle"),this.ui.toggleFiltersIcon.addClass("icon-collapse-alt"),this.ui.toggleFiltersIcon.removeClass("icon-expand-alt"),this.ui.toggleFiltersText.html("Show Filters")},n.prototype.onPageScroll=function(){var e;if(this.isClosed==null||this.isClosed)return;e=$(document).scrollTop();if(this.ui.navbar.hasClass("navbar-fixed-top")){if(e<this.navbarVerticalOffset-this.topNavbarHeight){this.ui.navbar.removeClass("navbar-fixed-top"),this.ui.contextContainer.css("top",this.workflowTopOffset);if(!this.areFiltersManuallyHidden)return this.showContextPanel()}}else if(e>=this.navbarVerticalOffset-this.topNavbarHeight){this.ui.navbar.css("top",this.topNavbarHeight),this.ui.navbar.addClass("navbar-fixed-top"),this.ui.contextContainer.css("top",this.workflowTopOffset+35);if(!this.areFiltersManuallyHidden)return this.hideContextPanel()}},n.prototype.selectPagesOption=function(){return this.$("#pages-radio-all").prop("checked",!1),this.$("#pages-radio-ranges").prop("checked",!0),this.$("#pages-text-ranges").val("")},n.prototype.changeExportStatus=function(e,t){var n;n=this.$(".export-status-"+e+" .span10"),n.children().hide();switch(t){case"pending":return n.find(".pending-container").show();case"downloading":return n.find(".progress").show();case"error":return n.find(".label-important").show();case"success":return n.find(".label-success").show();case"timeout":return n.find(".label-timeout").show()}},n.prototype.onExportFinished=function(e){this.numPendingDownloads=this.numPendingDownloads-1,this.$(".export-progress-container .badge-info").html(this.numPendingDownloads),this.hasExportErrorOccurred(e)?this.changeExportStatus(e,"error"):this.monitors[e].execution_time>this.monitorTimeout?this.changeExportStatus(e,"timeout"):this.changeExportStatus(e,"success");if(this.numPendingDownloads===0)return this.$("[data-toggle=export-options]").prop("disabled",!1),this.$(".export-progress-container").hide()},n.prototype.hasExportErrorOccurred=function(e){return this.$("#export-download-"+e).contents()[0].body.children.length!==0},n.prototype.checkExportStatus=function(e){var t;this.monitors[e].execution_time=this.monitors[e].execution_time+this.monitorDelay,t="export-type-"+e.toLowerCase();if(this.getCookie(t)==="complete")return clearInterval(this.monitors[e].interval),this.setCookie(t,null),this.onExportFinished(e);if(this.monitors[e].execution_time>this.monitorTimeout||this.hasExportErrorOccurred(e))return clearInterval(this.monitors[e].interval),this.onExportFinished(e)},n.prototype.setCookie=function(e,t){return document.cookie=""+e+"="+escape(t)+"; path=/"},n.prototype.getCookie=function(e){var t,n,r;return r=document.cookie,n=r.indexOf(" "+e+"="),n===-1&&(n=r.indexOf(""+e+"=")),n===-1?r=null:(n=r.indexOf("=",n)+1,t=r.indexOf(";",n),t===-1&&(t=r.length),r=unescape(r.substring(n,t))),r},n.prototype.startExport=function(e,t){var n,r,i,s;return i=this.$(e).attr("title"),this.changeExportStatus(i,"downloading"),n="export-type-"+i.toLowerCase(),this.setCookie(n,null),s=this.$(e).attr("href"),s[s.length-1]!=="/"&&(s=""+s+"/"),s=""+s+t,r="<iframe id=export-download-"+i+" src="+s+" style='display: none'></iframe>",this.$(".export-iframe-container").append(r),this.data.exporters.notifiesOnComplete()?(this.monitors[i]={},this.monitors[i].execution_time=0,this.monitors[i].interval=setInterval(this.checkExportStatus,this.monitorDelay,i)):setTimeout(this.onExportFinished,this.requestTimeout,i)},n.prototype.initializeExportStatusIndicators=function(e){var t,n,r,i;this.$(".export-status-container").children().hide(),i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(this.$(".export-status-"+t.title).show());return i},n.prototype.isPageRangeValid=function(){var e;return this.$("input[name=pages-radio]:checked").val()==="all"?!0:(e=this.$("#pages-text-ranges").val(),this.pageRangePattern.test(e))},n.prototype.exportData=function(e){var t,n,r,i,s,o,u;this.$(".export-iframe-container").empty(),i=this.$("input[name=export-type-checkbox]:checked");if(i.length===0)return this.$("#export-error-message").html("An export type must be selected."),this.$(".export-options-modal .alert-block").show();if(!this.isPageRangeValid())return this.$("#export-error-message").html("Please enter a valid page range. The page range must be a single page(example: 1) or a range of pages(example: 2...5)."),this.$(".export-options-modal .alert-block").show();this.numPendingDownloads=i.length,r="",this.$("input[name=pages-radio]:checked").val()!=="all"&&(r=this.$("#pages-text-ranges").val()+"/"),this.$("[data-toggle=export-options]").prop("disabled",!0),this.$(".export-progress-container").show(),this.$(".export-progress-container .badge-info").html(this.numPendingDownloads),this.ui.exportOptions.modal("hide"),this.initializeExportStatusIndicators(i),this.ui.exportProgress.modal("show"),t=this.requestDelay,this.data.exporters.notifiesOnComplete()||(t=this.requestTimeout),u=[];for(n=s=0,o=i.length-1;s<=o;n=s+=1)this.changeExportStatus(this.$(i[n]).attr("title"),"pending"),u.push(setTimeout(this.startExport,n*t,i[n],r));return u},n.prototype.onRender=function(){var e;r.isSupported("2.1.0")||(this.ui.saveQueryToggle.remove(),this.ui.saveQuery.remove()),this.paginator.show(new r.ui.Paginator({model:this.data.results})),this.count.show(new t({model:this.data.results,context:this.data.context})),this.exportTypes.show(new r.ui.ExportTypeCollection({collection:this.data.exporters})),this.exportProgress.show(new r.ui.ExportProgressCollection({collection:this.data.exporters})),this.resultDetailsModal.show(new i.ResultDetails),this.saveQueryModal.show(new r.ui.EditQueryDialog({header:"Save Query",view:this.data.view,context:this.data.context,collection:this.data.queries})),this.context.show(new r.ui.ContextPanel({model:this.data.context})),this.context.currentView.$el.stacked({fluid:".tree-region"}),this.table.show(new u.ResultTable({collection:this.data.results,view:this.data.view})),this.table.currentView.on("render",function(e){return function(){return e.$(".context").stacked("restack",e.$el.height())}}(this)),this.columns.show(new r.ui.ConceptColumns({view:this.data.view,concepts:this.data.concepts})),this.ui.navbarButtons.tooltip({animation:!1,placement:"bottom"}),this.navbarVerticalOffset==null&&(this.navbarVerticalOffset=this.ui.navbar.offset().top),this.topNavbarHeight==null&&(e=$(".navbar-fixed-top"),e.length?this.topNavbarHeight=e.height():this.topNavbarHeight=0);if(this.workflowTopOffset==null)return this.updateContextPanelOffsets()},n.prototype.showExportOptions=function(){this.$(".export-options-modal .alert-block").hide(),this.ui.exportOptions.modal("show");if(this.data.exporters.length===0)return this.$(".export-options-modal .btn-primary").prop("disabled",!0)},n.prototype.showExportProgress=function(){return this.ui.exportProgress.modal("show")},n.prototype.showSaveQuery=function(){return this.saveQueryModal.currentView.open()},n.prototype.renderPhenotypes=function(e,t){var n;if(!this.ui.viewPhenotype.is(":visible"))return;return this.ui.viewPhenotype.find(".loading").hide(),this.ui.recalculateButton.prop("disabled",!1),n=e.attributes,n.hpoAnnotations&&n.hpoAnnotations.length&&(n.hpoAnnotations=f.sortBy(n.hpoAnnotations,function(t){return parseInt(t.priority)||e.lowestPriority+1})),n.confirmedDiagnoses&&n.confirmedDiagnoses.length&&(n.confirmedDiagnoses=f.sortBy(n.confirmedDiagnoses,function(t){return parseInt(t.priority)||e.lowestPriority+1})),n.suspectedDiagnoses&&n.suspectedDiagnoses.length&&(n.suspectedDiagnoses=f.sortBy(n.suspectedDiagnoses,function(t){return parseInt(t.priority)||e.lowestPriority+1})),n.ruledOutDiagnoses&&n.ruledOutDiagnoses.length&&(n.ruledOutDiagnoses=f.sortBy(n.ruledOutDiagnoses,function(t){return parseInt(t.priority)||e.lowestPriority+1})),this.ui.viewPhenotype.find(".content").html(a.phenotypes(e.attributes)),this.phenotypeXhr=void 0},n.prototype.hidePhenotypes=function(){return this.phenotypeXhr&&this.phenotypeXhr.abort(),this.phenotypeXhr=void 0,this.ui.viewPhenotype.find(".content").empty(),this.ui.viewPhenotype.find(".loading").show()},n.prototype.phenotypesError=function(e,t){var n;if(t.statusText==="abort")return;return this.ui.viewPhenotype.find(".loading").hide(),(e!=null?(n=e.attributes)!=null?n.sample_id:void 0:void 0)!=null?this.ui.viewPhenotype.find(".content").html("<p>An error was encountered. "+("Unable to retrieve phenotypes for sample '"+e.attributes.sample_id+"'.</p>")):this.ui.viewPhenotype.find(".content").html("<p>An error was encountered. No sample is selected.</p>"),this.phenotypeXhr=void 0},n.prototype.sampleID=function(){var e,t;return t="various samples",this.data.context!=null&&(e=this.data.context.get("json"))!=null&&f.each(e.children,function(e){if(e.concept!=null&&e.concept===2)return t=e.children[0].value[0].label}),t},n.prototype.retrievePhenotypes=function(){var e,t;return this.ui.recalculateButton.prop("disabled",!0),t=this.sampleID(),t?($(".phenotype-sample-label").html("("+t+")"),e=new s.Phenotype({sample_id:t}),this.phenotypeXhr=e.fetch({success:this.renderPhenotypes,error:this.phenotypesError})):($(".phenotype-sample-label").html(""),this.phenotypesError(e,{}))},n}(e.Layout),{ResultsWorkflow:n}})